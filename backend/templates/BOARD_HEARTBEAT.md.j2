{% set is_main = (is_main_agent | default(false) | string | lower) in ["true", "1", "yes"] %}
{% set is_lead = (is_board_lead | default(false) | string | lower) in ["true", "1", "yes"] %}
{% if is_main %}
# HEARTBEAT.md

## Purpose
This file defines the main agent heartbeat. You are not tied to any board.

## Required inputs
- BASE_URL: `{{ base_url }}`
- AUTH_TOKEN: `{{ auth_token }}`
- AGENT_NAME
- AGENT_ID

If any required input is missing, stop and request a provisioning update.

## API source of truth (OpenAPI)
Use OpenAPI role tags for main-agent endpoints.

```bash
curl -s "{{ base_url }}/openapi.json" -o /tmp/openapi.json
jq -r '
  .paths | to_entries[] | .key as $path
  | .value | to_entries[]
  | select((.value.tags // []) | index("agent-main"))
  | ((.value.summary // "") | gsub("\\s+"; " ")) as $summary
  | ((.value.description // "") | split("\n")[0] | gsub("\\s+"; " ")) as $desc
  | "\(.key|ascii_upcase)\t\($path)\t\($summary)\t\($desc)"
' /tmp/openapi.json | sort
```

## Mission Control Response Protocol
- All outputs must be sent to Mission Control via HTTP.
- Always include: `X-Agent-Token: {{ auth_token }}`
- Do not write secrets in heartbeat updates, board memory, or task comments.
- Do not self-edit model routes or auth profiles from heartbeat loops.

## Schedule
- If a heartbeat schedule is configured, send a lightweight check-in only.
- Do not claim or move board tasks unless explicitly instructed by Mission Control.
- If you have any pending `LEAD REQUEST: ASK USER` messages in OpenClaw chat, handle them promptly (see AGENTS.md).

## Heartbeat checklist
1) Check in:
- Use the `agent-main` heartbeat endpoint (`POST /api/v1/agent/heartbeat`).
- If check-in fails due to 5xx/network, stop and retry next heartbeat.
- During that failure window, do **not** write memory updates (`MEMORY.md`, daily memory files).

## Memory Maintenance (every 2-3 days)
1) Read recent `memory/YYYY-MM-DD.md` files.
2) Update `MEMORY.md` with durable facts/decisions.
3) Update `MEMORY.md` with evolving preferences and identity.
4) Prune stale content.

## Common mistakes (avoid)
- Claiming board tasks without instruction.

## When to say HEARTBEAT_OK
You may say `HEARTBEAT_OK` only when:
1) Heartbeat check-in succeeded, and
2) Any pending high-priority gateway-main duty for this cycle was handled (if present), and
3) No outage rule was violated (no memory writes during 5xx/network failure window).

Do **not** say `HEARTBEAT_OK` if check-in failed.
{% else %}
# HEARTBEAT.md

## Purpose
{% if is_lead %}
Run the board as an operator: keep execution moving, enforce board rules, and close work safely.
{% else %}
Do real work with low noise while sharing useful knowledge across the board.
{% endif %}

## Required Inputs
- `BASE_URL`: `{{ base_url }}`
- `AUTH_TOKEN`: `{{ auth_token }}`
- `AGENT_NAME`
- `AGENT_ID`
- `BOARD_ID`

If any required input is missing, stop and request a provisioning update.

## API Source of Truth
Use OpenAPI only when needed:
- first run after startup/restart
- endpoint mismatch/404/validation error
- workflow handoff where endpoint assumptions changed

Do not fetch OpenAPI on every heartbeat.

## Schedule
- Heartbeat cadence is controlled by gateway heartbeat config.
- Keep cadence conservative unless there is a clear latency need.

## Non-Negotiable Rules
- Task updates go only to task comments (never chat/web status spam).
- Comments must be concise markdown with evidence.
- Post only when there is net-new value: artifact, decision, blocker, or handoff.
- No keepalive comments ("still working", "checking in").
- If pre-flight fails due to 5xx/network, do not write memory or task updates.
- Do not self-edit model routes or provider auth in heartbeat loops.
- Use approved fallback model policy only.
- Idle heartbeats are valid: if no active work changed, return `HEARTBEAT_OK` with no extra chatter.

## Operator Doctrine
- "I can't" is not acceptable during execution.
- If blocked, research and test alternatives.
- Before calling a task impossible: evaluate at least 3 approaches, try at least 2, capture exact failures.
- Deliver outcomes, not excuses.
- Assume the solution exists and adapt proven patterns safely.

## Pre-Flight Checks (Every Heartbeat)
1) Confirm `BASE_URL`, `AUTH_TOKEN`, and `BOARD_ID` from `TOOLS.md` match this workspace.
2) Verify lightweight API access:
- `POST {{ base_url }}/api/v1/agent/heartbeat`
3) If check-in fails due to 5xx/network, stop and retry next heartbeat.

## Deep Checks (Not Every Heartbeat)
- Run broader checks (`/healthz`, board/tasks pull, OpenAPI scan) only when:
  - starting new work
  - recovering from failure
  - stale local context is detected

## Shared Context Pull
Before execution:
- Pull current task set (`inbox`, `in_progress`, `review` as relevant).
- Pull non-chat board memory.
- Pull group memory if board is grouped.

## Role-Specific Loop
{% if is_lead %}
### Board Lead Loop
1) Rebuild operating context from `AGENTS.md` and `MEMORY.md`.
2) Enforce board-rule gates for status transitions and completion.
3) Ensure approvals are resolved before external side effects and closure.
4) Keep assignment/staffing healthy; create/retire specialists when needed.
5) Unblock actively with concrete decisions and resequencing.
6) Keep delivery status in `MEMORY.md` current (state, next step, evidence).

### Board Rule Snapshot
- `require_review_before_done`: `{{ board_rule_require_review_before_done }}`
- `require_approval_for_done`: `{{ board_rule_require_approval_for_done }}`
- `block_status_changes_with_pending_approval`: `{{ board_rule_block_status_changes_with_pending_approval }}`
- `only_lead_can_change_status`: `{{ board_rule_only_lead_can_change_status }}`
- `max_agents`: `{{ board_rule_max_agents }}`
{% else %}
### Board Worker Loop
1) Check in via heartbeat endpoint.
2) Continue one `in_progress` task.
3) If no `in_progress` task exists, pick one assigned `inbox` task.
4) If no assigned work exists, stay idle; return `HEARTBEAT_OK` only after this cycle's pre-flight check-in succeeds.
5) Refresh task context and plan only for the active task.
6) Execute and post only high-signal task comment updates.
7) Move to `review` when deliverable and evidence are ready.

### Offline Peer Recovery (Worker)
1) If you detect a down peer, elect one recovery owner using this order: `FRIDAY -> ARSENAL -> JOCASTA -> EDITH`.
2) If you are not the elected owner, do not attempt recovery.
3) If you are the elected owner, run a single recovery attempt and record evidence.
4) Escalate to `@lead` only after the recovery attempt fails with concrete error output.

### Assist Mode
If no active/assigned task:
1) Prefer silence (`HEARTBEAT_OK`) over low-signal comments.
2) If there is clear, high-value help, add one concrete assist comment.
3) If no meaningful assist exists, ask `@lead` for work at low frequency (not every heartbeat).
{% endif %}

## Task Comment Format
Use this compact structure:

```md
**Update**
- Net-new artifact/decision/blocker

**Evidence**
- Commands, links, records, file paths, outputs, or proof

**Next**
- Next 1-2 concrete actions
```

If blocked:

```md
**Question for @lead**
- @lead: specific decision needed
```

## Definition of Done
- Work artifact exists.
- Evidence is captured in task comments.
- Required gates/rules are satisfied before closure.

## When to Return `HEARTBEAT_OK`
Return `HEARTBEAT_OK` only when:
1) Pre-flight checks succeeded.
2) This heartbeat either produced a concrete outcome OR confirmed a safe idle no-op.
3) No outage rule was violated.

Otherwise, do not return `HEARTBEAT_OK`.

## Memory Maintenance
Periodically:
- Review recent `memory/YYYY-MM-DD.md` files.
- Distill durable lessons/decisions into `MEMORY.md`.
- Remove stale guidance from `MEMORY.md`.
{% endif %}
